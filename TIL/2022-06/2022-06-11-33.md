## Learned

---

> **[[1ì¼ 1ë¡œê·¸ 100ì¼ ì™„ì„± ITì§€ì‹] í•˜ë“œì›¨ì–´ 43~51](https://velog.io/@lilclown/1%EC%9D%BC-1%EB%A1%9C%EA%B7%B8-100%EC%9D%BC-%EC%99%84%EC%84%B1-IT%EC%A7%80%EC%8B%9D-%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B44351)**

<br><br>

## Coding

---

1. error handling

```javascript
app.use((err, req, res, next) => {
  res.status(err.status || 400).json({ result: false, message: err.message });
});
```

<br>

2. 404 error

```javascript
app.use(function (req, res, next) {
  res.status(404).send('ìš”ì²­í•˜ì‹  í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
});
```

<br>

3. mongoose-sequence(postId ê°’ ìë™ìœ¼ë¡œ ì¦ê°€)

- ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

```
npm install --save mongoose-sequence
```

- schemas/posts.js

```javascript
const AutoIncrement = require('mongoose-sequence')(mongoose);

postsSchema.plugin(AutoIncrement, { start_seq: 1, inc_field: 'postId' });
```

<br>

4. ê³„ì¸µ ë¶„ë¦¬

- Router : URI(ë˜ëŠ” ê²½ë¡œ) ë° íŠ¹ì •í•œ HTTP ìš”ì²­ ë©”ì†Œë“œ(CRUD)ì¸ íŠ¹ì • ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‘ë‹µ

```javascript
const express = require('express');
const router = express.Router();
const auth = require('../middlewares/auth');
const postsController = require('../controllers/postsController');
const wrap = require('../controllers/wrapAsyncController').wrapAsyncController;

//ê²Œì‹œê¸€ ì‘ì„±
// router.post('/posts', auth, postsController.addPosts);
router.post('/posts', auth, wrap(postsController.addPosts));

//ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ
router.get('/posts', postsController.loockupAllPosts);

//ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
router.get('/posts/:postId', postsController.loockupDetailPost);

//ê²Œì‹œê¸€ ìˆ˜ì •
router.put('/posts/:postId', auth, postsController.editPost);

//ê²Œì‹œê¸€ ì‚­ì œ
router.delete('/posts/:postId', auth, postsController.deletePost);

module.exports = router;
```

- Controller : Service ê³„ì¸µì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ì‘ë‹µ

```javascript
const postsService = require('../services/postsService');

//module.exposts

//ê²Œì‹œê¸€ ì‘ì„±
async function addPosts(req, res, next) {
  try {
    const { nickname } = res.locals.user;
    const { title, content } = req.body;
    const { category } = req.query;

    await postsService.addPosts(category, nickname, title, content);
    res.json({ success: true });
  } catch (error) {
    next({
      message: error.serviceError || 'ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨ğŸ”´',
      error,
      status: 500,
    });
  }
}

//ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ
async function loockupAllPosts(req, res, next) {
  try {
    const { category } = req.query;

    const posts = await postsService.loockupAllPosts(category);

    //express-async-errors
    // if (!posts) {
    //   throw new Error({});
    // }

    res.json({
      posts,
    });
  } catch (error) {
    next({
      message: error.serviceError || 'ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ ì‹¤íŒ¨ğŸ”´',
      error,
      status: 500,
    });
  }
}

//ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
async function loockupDetailPost(req, res, next) {
  try {
    const { postId } = req.params;

    const post = await postsService.loockupDetailPost(postId);

    res.json({
      post,
    });
  } catch (error) {
    next({
      message: error.serviceError || 'ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨ğŸ”´',
      error,
      status: 500,
    });
  }
}

//ê²Œì‹œê¸€ ìˆ˜ì •
async function editPost(req, res, next) {
  try {
    const { nickname } = res.locals.user;
    const { postId } = req.params;
    const { title, content } = req.body;

    await postsService.editPost(nickname, postId, title, content);

    res.json({ success: true });
  } catch (error) {
    next({
      message: error.serviceError || 'ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤íŒ¨ğŸ”´',
      error,
      status: 500,
    });
  }
}

//ê²Œì‹œê¸€ ì‚­ì œ
async function deletePost(req, res, next) {
  try {
    const { nickname } = res.locals.user;
    const { postId } = req.params;

    await postsService.deletePost(nickname, postId);

    res.json({ success: true });
  } catch (error) {
    next({
      message: error.serviceError || 'ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨ğŸ”´',
      error,
      status: 500,
    });
  }
}
module.exports = {
  addPosts,
  loockupAllPosts,
  loockupDetailPost,
  editPost,
  deletePost,
};
```

- Service : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

```javascript
const Posts = require('../schemas/posts');

//export

//ê²Œì‹œê¸€ ì‘ì„±
exports.addPosts = async (category, nickname, title, content) => {
  try {
    await Posts.create({
      category,
      nickname,
      title,
      content,
    });
  } catch (error) {
    throw { error, serviceError: 'ê²Œì‹œê¸€ ì‘ì„± DB ì˜¤ë¥˜ğŸ”´' };
  }
};

//ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ
exports.loockupAllPosts = async (category) => {
  try {
    return await Posts.find({ category }, { _id: 0, postId: 1, nickname: 1, title: 1, date: 1 }).sort({ date: -1 });
  } catch (error) {
    throw { error, serviceError: 'ê²Œì‹œê¸€ ì „ì²´ ì¡°íšŒ DB ì˜¤ë¥˜ğŸ”´' };
  }
};

//ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
exports.loockupDetailPost = async (postId) => {
  try {
    return await Posts.find({ postId: Number(postId) }, { _id: 0 });
  } catch (error) {
    throw { error, serviceError: 'ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨(DB)ğŸ”´' };
  }
};

//ê²Œì‹œê¸€ ìˆ˜ì •
exports.editPost = async (nickname, postId, title, content) => {
  try {
    const checkNickname = await Posts.findOne({ postId: Number(postId) });
    if (checkNickname['nickname'] !== nickname) {
      res.status(400).send({
        errorMessage: 'ë³¸ì¸ì´ ì‘ì„±í•œ ê²Œì‹œê¸€ì´ ì•„ë‹™ë‹ˆë‹¤.',
      });
      return;
    }

    await Posts.updateOne({ postId: Number(postId) }, { $set: { title, content } });
  } catch (error) {
    throw { error, serviceError: 'ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤íŒ¨(DB)ğŸ”´' };
  }
};

//ê²Œì‹œê¸€ ì‚­ì œ
exports.deletePost = async (nickname, postId) => {
  try {
    const checkNickname = await Posts.findOne({ postId: Number(postId) });
    if (checkNickname['nickname'] !== nickname) {
      res.status(400).send({
        errorMessage: 'ë³¸ì¸ì´ ì‘ì„±í•œ ê²Œì‹œê¸€ì´ ì•„ë‹™ë‹ˆë‹¤.',
      });
      return;
    }

    await Posts.deleteOne({ postId: Number(postId) });
  } catch (error) {
    throw { error, serviceError: 'ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨(DB)ğŸ”´' };
  }
};
```

<br>

5. wrapAsync

```javascript
//wrapAsyncController
const wrapAsyncController = (fn) => {
  return (req, res, next) => {
    fn(req, res, next).catch(next);
  };
};

module.exports = { wrapAsyncController };
```

```javascript
const wrap = require('../controllers/wrapAsyncController').wrapAsyncController;

router.post('/posts', auth, wrap(postsController.addPosts));
```

<br><br>

## Retrospect

---

<br>

> **- ì˜¤ëŠ˜ í•œì¼ -**

- **ì½”ë“œì‡ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì¤‘ê¸‰ ìˆ˜ê°•**
- ~~**1ì¼ 1ë¡œê·¸ 100ì¼ ì™„ì„± ITì§€ì‹ 43~51**~~
- ~~**W6 ë¯¸ë‹ˆí”„ë¡œì íŠ¸ ê²Œì‹œë¬¼ ê´€ë ¨ API ì™„ì„±**~~
- ~~**ì—ëŸ¬ í•¸ë“¤ë§, routes ì˜ì¡´ì„± ë¶„ë¦¬**~~
- **swagger**

<br>

> **- ë‚´ì¼ í• ì¼ -**

- **ì½”ë“œì‡ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì¤‘ê¸‰ ìˆ˜ê°•**
- **swagger**

<br><br>

> **Tomorrow better than today, Laugh at myself**
